# Implementation: File Browser (Phase 6)

**Date:** 2026-01-04
**Status:** Completed

## Summary

Implemented the file browser feature allowing users to navigate directories inside a pod, view file contents, and see file metadata. This uses `exec` under the hood to run `ls -la` and `cat` commands.

## Files Created

### internal/k8s/files.go
- `FileInfo` struct - represents file/directory entry with name, permissions, size, owner, etc.
- `FileOptions` struct - configures file operations (namespace, pod, container, path)
- `ListDir(ctx, opts)` method - runs `ls -la` and parses output into FileInfo entries
- `ReadFile(ctx, opts, maxBytes)` method - reads file contents using `head -c` for size limiting
- `StatFile(ctx, opts)` method - gets file info for a single path
- `ParseLsOutput(output)` - parses `ls -la` output into FileInfo entries
- `parseLsLine(line)` - parses single line with regex to handle variable whitespace
- `FormatSize(size)` - formats bytes as human-readable (K/M/G)
- `JoinPath(base, name)` - joins path components handling trailing slashes
- `ParentPath(path)` - returns parent directory path

### internal/k8s/files_test.go
- Tests for `FileOptions.Validate()`
- Tests for `ParseLsOutput()` with various formats (files, dirs, symlinks)
- Tests for `parseLsLine()` edge cases
- Tests for `FormatSize()` with different sizes
- Tests for `JoinPath()` and `ParentPath()` path manipulation

### internal/ui/files.go
- `FileBrowserState` enum - Idle, Loading, Ready, Error, ViewingFile
- `FileBrowserModel` struct - manages file browser UI with:
  - Directory listing with scrolling
  - File preview with viewport
  - Path history for back navigation
  - Navigation methods (up/down/enter/backspace)
- Methods for navigation, path history, file viewing
- View rendering with icons (D/F/L for dir/file/link)

### internal/ui/files_test.go
- Tests for initialization and configuration
- Tests for navigation (up/down/top/bottom)
- Tests for path history (push/pop)
- Tests for entry navigation (directories, files, symlinks)
- Tests for file viewing mode
- Tests for view rendering in different states

## Files Modified

### internal/app/app.go
- Added `dirLoadedMsg`, `fileContentMsg` message types
- Added `filesView`, `filesCancel` fields to Model
- Initialize `filesView` in `New()`
- Handle `dirLoadedMsg` and `fileContentMsg` in `Update()`
- Added `loadDirectory(path)` - async command to load directory contents
- Added `loadFileContent(path, filename)` - async command to load file preview
- Added `handleFilesViewKeys()` - processes navigation keys (Enter, Backspace, j/k)
- Added `stopFileBrowser()` - cleans up file browser state
- Updated `handleBack()` to handle files view (exit file view or go back to pod list)
- Updated `handlePodListKeys()` - 'f' key now requires pods (like logs/exec)
- Updated `viewFiles()` to render FileBrowserModel

### internal/app/app_test.go
- Updated `TestUpdate_ViewNavigation` - files view now requires pods
- Added `TestUpdate_FilesViewNavigation`
- Added `TestUpdate_FilesViewRequiresPods`
- Added `TestUpdate_FilesViewBackNavigation`
- Added `TestUpdate_FilesViewInitialization`

## Keybindings (Files View)

| Key | Action |
|-----|--------|
| `j/↓` | Move selection down |
| `k/↑` | Move selection up |
| `Enter` | Open directory / View file |
| `Backspace` | Go to parent directory |
| `g` | Go to top of list |
| `G` | Go to bottom of list |
| `pgup/pgdn` | Page up/down (in file preview) |
| `Esc` | Back to pod list |

## Architecture

The file browser uses async commands like log streaming:

1. User presses 'f' on pod → switch to ViewFiles, initialize FileBrowserModel, load root dir
2. `loadDirectory("/")` runs `ls -la` via exec, returns `dirLoadedMsg`
3. Entries displayed in list, user navigates with j/k
4. User presses Enter on dir → `loadDirectory(path)` loads new directory
5. User presses Enter on file → `loadFileContent(path)` loads content
6. User presses Backspace → navigate to parent using path history
7. User presses Esc → return to pod list

## Testing

- `make test` - 116 tests pass (added 4 new app tests, ~40 new k8s/ui tests)
- `make lint` - 0 issues
- `go build` - successful

## Limitations / Out of Scope

- File download/copy to local machine
- File editing
- Binary file detection/handling
- Syntax highlighting for code files
- File search within directory
- Copy path to clipboard
- Maximum file preview size is 100KB

## Future Enhancements

- Add syntax highlighting for common file types
- Add file search/filter (/ key)
- Add file download capability
- Show file type icons (use emojis when appropriate)
- Binary file warning/handling
